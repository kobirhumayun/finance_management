# syntax=docker/dockerfile:1.7

FROM node:22-bookworm-slim AS base

ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
WORKDIR /app

# Install system dependencies for Playwright and other tools
# We use npx playwright install-deps to ensure we get exactly what Playwright needs
# We also install dumb-init and other basics
RUN apt-get update \
  && apt-get install -y --no-install-recommends \
  ca-certificates \
  curl \
  dumb-init \
  wget \
  xdg-utils \
  && rm -rf /var/lib/apt/lists/* \
  && mkdir -p /ms-playwright \
  && mkdir -p /app/uploads \
  && chown node:node /app/uploads

COPY package*.json ./

# Install dependencies including Playwright
RUN npm install --omit=dev

# Install Playwright system dependencies and the browser
# We need to install the browser binary as well
RUN npx playwright install-deps chromium \
  && npx playwright install chromium

COPY --chown=node:node . .

USER node

HEALTHCHECK --interval=30s --timeout=5s --retries=5 --start-period=40s \
  CMD node /app/workers/pdfHealthcheck.js

ENTRYPOINT ["dumb-init", "--"]
CMD ["node", "workers/pdfWorker.js"]
