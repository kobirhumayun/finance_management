services:
  finance-management-web:
    build: null
    image: node:24-bookworm-slim
    entrypoint: ["sh", "-c"]
    command: "npm install && npm run dev"
    working_dir: /app
    environment:
      HOSTNAME: 0.0.0.0
      WEB_NODE_ENV: ${WEB_NODE_ENV:-development}
      NODE_ENV: ${WEB_NODE_ENV:-development}
      NEXT_TELEMETRY_DISABLED: 1
      NEXT_FONT_IGNORE_REMOTE_FONT_ERRORS: 1
      NEXT_FORCE_WEBPACK: 1
      NEXT_USE_TURBOPACK: 0
      NEXT_TURBOPACK_USE_WORKER: 0
    ports:
      - "${WEB_PORT:-3000}:3000"
    volumes:
      - ./client:/app
      - web_node_modules:/app/node_modules
      - web_next:/app/.next
    depends_on:
      finance-management-api:
        condition: service_started
      finance-management-redis:
        condition: service_started
    healthcheck: null

  finance-management-api:
    build: null
    image: node:24-bookworm-slim
    entrypoint: ["sh", "-c"]
    command: "npm install && npm run dev"
    working_dir: /app
    environment:
      MONGO_URI: ${MONGO_URI:-mongodb://${MONGO_USERNAME:-root}:${MONGO_PASSWORD:-example}@finance-management-db:27017/${MONGO_DATABASE:-finance-management}?authSource=admin}
      API_NODE_ENV: ${API_NODE_ENV:-development}
      NODE_ENV: ${API_NODE_ENV:-development}
    ports:
      - "${API_PORT:-5000}:5000"
    volumes:
      - ./server:/app
      - api_node_modules:/app/node_modules
      - api_ms_playwright:/ms-playwright
    depends_on:
      finance-management-redis:
        condition: service_started
    healthcheck: null

  finance-management-db:
    profiles: ["local-db"]
    image: mongo:8.0
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-example}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-finance-management}
    volumes:
      - finance-management-mongo-data:/data/db
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
          pids: 256
    ulimits:
      nofile:
        soft: 4096
        hard: 8192
    healthcheck:
      test:
        - "CMD-SHELL"
        - >-
          mongosh --host 127.0.0.1 --username "$$MONGO_INITDB_ROOT_USERNAME" --password "$$MONGO_INITDB_ROOT_PASSWORD" --authenticationDatabase admin --quiet --eval 'db.adminCommand({ ping: 1 })' || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - finance-management_net

volumes:
  finance-management-mongo-data:
    driver: local
  web_node_modules:
    driver: local
  web_next:
    driver: local
  api_node_modules:
    driver: local
  api_ms_playwright:
    driver: local
