x-service-defaults: &service-defaults
  restart: unless-stopped
  ulimits:
    nofile:
      soft: 4096
      hard: 8192

x-app-deploy: &app-deploy
  resources:
    limits:
      cpus: "0.75"
      memory: 768M
      pids: 256

x-db-deploy: &db-deploy
  resources:
    limits:
      cpus: "1.0"
      memory: 1G
      pids: 256

x-cache-deploy: &cache-deploy
  resources:
    limits:
      cpus: "0.50"
      memory: 256M
      pids: 128

services:
  finance-management-web:
    <<: *service-defaults
    deploy:
      <<: *app-deploy
    build:
      context: ./client
      target: production
    image: finance-management-web:latest
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${WEB_PORT}
      AUTH_BACKEND_URL: ${AUTH_BACKEND_URL:-http://finance-management-api:5000}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-https://finance.example.com}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      REDIS_URL: ${REDIS_URL:-redis://finance-management-redis:6379}
      NEXT_PUBLIC_PASSWORD_RESET_REDIRECT_URL: ${NEXT_PUBLIC_PASSWORD_RESET_REDIRECT_URL}
      PROXY_TIMEOUT_MS: ${PROXY_TIMEOUT_MS:-15000}
      PASSWORD_RESET_TIMEOUT_MS: ${PASSWORD_RESET_TIMEOUT_MS:-15000}
      REGISTER_TIMEOUT_MS: ${REGISTER_TIMEOUT_MS:-15000}
      AUTH_REFRESH_PATH: ${AUTH_REFRESH_PATH:-/api/users/refresh-token}
      AUTH_REDIS_PREFIX: ${AUTH_REDIS_PREFIX:-auth:v1}
      AUTH_KEY_SALT: ${AUTH_KEY_SALT}
      REDIS_CONNECT_TIMEOUT_MS: ${REDIS_CONNECT_TIMEOUT_MS:-10000}
      BASE_URL: ${BASE_URL:-https://finance.example.com}
    depends_on:
      finance-management-api:
        condition: service_healthy
      finance-management-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:${WEB_PORT}/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - finance-management_net
      - edge_net

  finance-management-api:
    <<: *service-defaults
    deploy:
      <<: *app-deploy
    build:
      context: ./server
      target: production
    image: finance-management-api:latest
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${API_PORT}
      MONGO_URI: ${MONGO_URI}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      ACCESS_TOKEN_SECRET: ${ACCESS_TOKEN_SECRET}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET}
      ACCESS_TOKEN_EXPIRY: ${ACCESS_TOKEN_EXPIRY:-15m}
      REFRESH_TOKEN_EXPIRY: ${REFRESH_TOKEN_EXPIRY:-7d}
      OTP_EXPIRY_MINUTES: ${OTP_EXPIRY_MINUTES:-10}
      ADMIN_RECENT_LOGIN_LIMIT: ${ADMIN_RECENT_LOGIN_LIMIT:-5}
      DEFAULT_PASSWORD_RESET_REDIRECT: ${DEFAULT_PASSWORD_RESET_REDIRECT}
      SUBSCRIPTION_JOB_LOCK_TTL_MS: ${SUBSCRIPTION_JOB_LOCK_TTL_MS:-900000}
      JOB_INSTANCE_ID: ${JOB_INSTANCE_ID:-finance-management-worker}
      EMAIL_PROVIDER: ${EMAIL_PROVIDER:-smtp}
      EMAIL_SERVICE: ${EMAIL_SERVICE}
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASS: ${EMAIL_PASS}
      EMAIL_API_KEY: ${EMAIL_API_KEY}
      EMAIL_API_USER: ${EMAIL_API_USER}
      EMAIL_FROM: ${EMAIL_FROM}
      EMAIL_SECURE: ${EMAIL_SECURE:-false}
      EMAIL_REQUIRE_TLS: ${EMAIL_REQUIRE_TLS:-true}
      EMAIL_TLS_REJECT_UNAUTHORIZED: ${EMAIL_TLS_REJECT_UNAUTHORIZED:-true}
      EMAIL_TLS_MIN_VERSION: ${EMAIL_TLS_MIN_VERSION}
      EMAIL_TLS_CIPHERS: ${EMAIL_TLS_CIPHERS}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:${API_PORT}/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - finance-management_net

  finance-management-db:
    <<: *service-defaults
    deploy:
      <<: *db-deploy
    image: mongo:8.0
    profiles:
      - local-db
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE}
    volumes:
      - finance-management-mongo-data:/data/db
    healthcheck:
      test:
        - CMD-SHELL
        - >-
          mongosh --host 127.0.0.1 --username "$${MONGO_USERNAME}" --password "$${MONGO_PASSWORD}" --authenticationDatabase admin --quiet --eval 'db.adminCommand({ ping: 1 })' || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - finance-management_net

  finance-management-redis:
    <<: *service-defaults
    deploy:
      <<: *cache-deploy
    image: redis:7.4-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - finance-management_net
    volumes:
      - finance-management-redis-data:/data

volumes:
  finance-management-mongo-data:
    driver: local
  finance-management-redis-data:
    driver: local

networks:
  finance-management_net:
    driver: bridge
    internal: true
  edge_net:
    external: true
