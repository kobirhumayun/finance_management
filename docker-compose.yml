services:
  finance-management-web:
    build:
      context: ./client
    image: finance-management-web:latest
    env_file:
      - .env
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${WEB_PORT:-3000}
      AUTH_BACKEND_URL: ${AUTH_BACKEND_URL:-http://finance-management-api:5000}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-https://finance.example.com}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      REDIS_URL: ${REDIS_URL:-redis://finance-management-redis:6379}
      NEXT_PUBLIC_PASSWORD_RESET_REDIRECT_URL: ${NEXT_PUBLIC_PASSWORD_RESET_REDIRECT_URL}
      PROXY_TIMEOUT_MS: ${PROXY_TIMEOUT_MS:-15000}
      PASSWORD_RESET_TIMEOUT_MS: ${PASSWORD_RESET_TIMEOUT_MS:-15000}
      REGISTER_TIMEOUT_MS: ${REGISTER_TIMEOUT_MS:-15000}
      AUTH_REFRESH_PATH: ${AUTH_REFRESH_PATH:-/api/users/refresh-token}
      AUTH_REDIS_PREFIX: ${AUTH_REDIS_PREFIX:-auth:v1}
      AUTH_KEY_SALT: ${AUTH_KEY_SALT}
      REDIS_CONNECT_TIMEOUT_MS: ${REDIS_CONNECT_TIMEOUT_MS:-10000}
    depends_on:
      finance-management-api:
        condition: service_healthy
      finance-management-redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.75"
          memory: 768M
          pids: 256
    ulimits:
      nofile:
        soft: 4096
        hard: 8192
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:${WEB_PORT:-3000}/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - finance-management_net
      - edge_net

  finance-management-api:
    build:
      context: ./server
    image: finance-management-api:latest
    env_file:
      - .env
    environment:
      MONGO_URI: ${MONGO_URI}
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${API_PORT:-5000}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
    depends_on:
      finance-management-redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.75"
          memory: 768M
          pids: 256
    ulimits:
      nofile:
        soft: 4096
        hard: 8192
    volumes:
      - finance-management-uploads:${UPLOADS_ROOT:-/app/uploads}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:${API_PORT:-5000}/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - finance-management_net
      - finance-management_outbound

  finance-management-db:
    image: mongo:8.0
    profiles:
      - localdb
    env_file:
      - .env
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE}
    volumes:
      - finance-management-mongo-data:/data/db
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
          pids: 256
    ulimits:
      nofile:
        soft: 4096
        hard: 8192
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mongosh --host 127.0.0.1 --username \"$$MONGO_USERNAME\" --password \"$$MONGO_PASSWORD\" --authenticationDatabase admin --quiet --eval 'db.adminCommand({ ping: 1 })' || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - finance-management_net

  finance-management-redis:
    image: redis:7.4-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: 256M
          pids: 128
    ulimits:
      nofile:
        soft: 4096
        hard: 8192
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - finance-management_net
    volumes:
      - finance-management-redis-data:/data

  finance-management-backup:
    build: ./backup
    container_name: finance-management-backup
    # "no" is crucial: This is a task, not a service that stays alive
    restart: "no"
    env_file:
      - .env
    environment:
      MONGO_URI: ${MONGO_URI}
      RESTIC_PASSWORD: ${RESTIC_PASSWORD}
      RESTIC_REPOSITORY: "/repo"
    volumes:
      # Read/Write access allows you to restore files back to this volume
      - finance-management-uploads:/data/uploads
      # Maps a folder on your VPS host to the container
      - ./backups:/repo
    networks:
      - finance-management_net
      - finance-management_outbound

volumes:
  finance-management-mongo-data:
    driver: local
  finance-management-redis-data:
    driver: local
  finance-management-uploads:
    driver: local

networks:
  finance-management_net:
    driver: bridge
    internal: true
  finance-management_outbound:
    driver: bridge
  edge_net:
    external: true
