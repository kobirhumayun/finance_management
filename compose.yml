x-service-defaults: &service-defaults
  restart: unless-stopped
  ulimits:
    nofile:
      soft: 4096
      hard: 8192

x-web-api-resources: &web_api_resources
  deploy:
    resources:
      limits:
        cpus: "0.75"
        memory: 768M
        pids: 256

x-redis-resources: &redis_resources
  deploy:
    resources:
      limits:
        cpus: "0.50"
        memory: 256M
        pids: 128

services:
  finance-management-web:
    <<: [*service-defaults, *web_api_resources]
    build:
      context: ./client
      target: production
    image: finance-management-web:latest
    env_file:
      - ./client/.env.compose
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${WEB_PORT:-3000}
      AUTH_BACKEND_URL: ${AUTH_BACKEND_URL:-http://finance-management-api:5000}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-https://finance.example.com}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-change-me}
      REDIS_URL: ${REDIS_URL:-redis://finance-management-redis:6379}
      NEXT_PUBLIC_PASSWORD_RESET_REDIRECT_URL: ${NEXT_PUBLIC_PASSWORD_RESET_REDIRECT_URL:-https://finance.example.com/reset-password}
      PROXY_TIMEOUT_MS: ${PROXY_TIMEOUT_MS:-15000}
      PASSWORD_RESET_TIMEOUT_MS: ${PASSWORD_RESET_TIMEOUT_MS:-15000}
      REGISTER_TIMEOUT_MS: ${REGISTER_TIMEOUT_MS:-15000}
      AUTH_REFRESH_PATH: ${AUTH_REFRESH_PATH:-/api/users/refresh-token}
      AUTH_REDIS_PREFIX: ${AUTH_REDIS_PREFIX:-auth:v1}
      AUTH_KEY_SALT: ${AUTH_KEY_SALT:-}
      REDIS_CONNECT_TIMEOUT_MS: ${REDIS_CONNECT_TIMEOUT_MS:-10000}
    depends_on:
      finance-management-api:
        condition: service_healthy
      finance-management-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:${WEB_PORT:-3000}/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - finance-management_net
      - edge_net

  finance-management-api:
    <<: [*service-defaults, *web_api_resources]
    build:
      context: ./server
      target: production
    image: finance-management-api:latest
    env_file:
      - ./server/.env.compose
    environment:
      MONGO_URI: ${MONGO_URI:-mongodb://finance-management-db:27017/finance-management}
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${API_PORT:-5000}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000}
      REDIS_URL: ${REDIS_URL:-redis://finance-management-redis:6379}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:${API_PORT:-5000}/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - finance-management_net

  finance-management-redis:
    <<: [*service-defaults, *redis_resources]
    image: redis:7.4-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - finance-management_net
    volumes:
      - finance-management-redis-data:/data

volumes:
  finance-management-redis-data:
    driver: local

networks:
  finance-management_net:
    driver: bridge
    internal: true
  edge_net:
    external: true
